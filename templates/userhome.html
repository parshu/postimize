
{% block content %}
  
<!DOCTYPE html>
<html>

{% include "htmlhead.html" %}

<body>

{% include "header.html" %}

{% include "publish_modal.html" %}

</div>


<div id="clickedjobinfo"></div>
<div id="foo" class="col_3">
<button class="large green"  style="width:100%;margin-bottom:10px;">Import More Jobs</button>
<ul class="tabs" >
<li><a href="#tabl1" onclick="$('#jobsbyonetdiv').hide();$('#jobdescdiv').show();">By Job</a></li>
<li><a href="#tabl2" onclick="$('#jobsbyonetdiv').show();$('#jobdescdiv').hide();loadBulkValues('selected categories','111','-1');updateTotals('init');">By Category</a></li>
<li><a href="#tabl3">By Company</a></li>

</ul>
<div id="tabl1" class="tab-content" style="margin:0px;padding:0px;">
<ul class="menu vertical">

{% for job in demojobs %}
	<div id="{{job['jobid']}}" style="display:none;background-color:{{loop.cycle('#F0F0F0', '#FCFCFC')}};"><li litype="job" id="li{{job['jobid']}}">
	<a id="joblink{{job['jobid']}}" href="#" onclick="$('li[litype*=&quot;job&quot;]').attr('class','current').removeClass();$('#li{{job['jobid']}}').addClass('current');loadValues('{{job['jobid']}}','{{job['plan']}}','{{job['damping']}}','{{job['title']}}','{{job['city']}}, {{job['state']}}');updateTotals('init');"><img src="{{job['loo']}}" width="15px" height="15px"></img>&nbsp;&nbsp;<span>{{job['title']}}</span></a></li></div>
{% endfor %}

</ul>
</div>
<div id="tabl2" class="tab-content" style="margin:0px;padding:0px;overflow:0px;display:none;">
<ul class="menu vertical">
{% for onet in jobsbyonet.keys() %}
	<div id="onet{{loop.index}}" style="background-color:{{loop.cycle('#F0F0F0', '#FCFCFC')}};"><li litype="onet" onetcode="{{onetdesctocode[onet]}}" id="onetli{{loop.index}}">
	<a id="onetlink{{loop.index}}" href="#" onclick="$('#onetli{{loop.index}}').toggleClass('current');togglecheck('#onetcheckbox{{loop.index}}');$('#onetdiv{{loop.index}}').toggle();loadBulkValues('{{onet}}','{{onetdesctocode[onet]}}','-1');updateTotals('init');"><input type="checkbox" checkboxsource="onet" autocomplete="off" onclick="" id="onetcheckbox{{loop.index}}"/>&nbsp;&nbsp;<span>{{onet}}</span><span style="float:right;color:darkorange;">{{onetcounts[onet]}}</span></a></li></div>
{% endfor %}
</ul>
</div>

<div id="tabl3" class="tab-content" style="margin:0px;padding:0px;">
</div>

</div>

<div id="jobsbyonetdiv" class="col_3" style="display:none;">
	{% for onet in jobsbyonet.keys() %}
	<div id="onetdiv{{loop.index}}" style="display:none;">
		<ul class="menu vertical">
		
		{% for job in jobsbyonet[onet] %}
			<div id="ojob{{job['jobid']}}" style="background-color:{{loop.cycle('#F0F0F0', '#FCFCFC')}};"><li id="ojobli{{job['jobid']}}">
			
			<a id="ojoblink{{job['jobid']}}" href="#"><input type="checkbox" checkboxsource="onetjob" autocomplete="off" onclick="" id="ojobcheckbox{{job['jobid']}}" checked="yes"/>&nbsp;&nbsp;<img src="{{job['loo']}}" width="15px" height="15px"></img>&nbsp;&nbsp;<span>{{job['title']}}</span></a></li></div>
		{% endfor %}
		
		</ul>
	</div>
	{% endfor %}

</div>
<div id="jobdescdiv" class="col_3" style="background-color:white;">
	job desc here

</div>

<div class="col_6">
<ul class="tabs left" >
<li><a href="#tabr1">Campaign</a></li>
<li><a href="#tabr2">Edit/Sync Job</a></li>
<li><a href="#tabr3">Performance</a></li>
</ul>

<div id="tabr1" class="tab-content" style="background-color:white;">

	<span style="color:grey; font-weight:bold;">You optimized publish plan for a </span><span id="jobtitle" style="color:#f6931f; font-weight:bold;"></span><span style="color:grey; font-weight:bold;"> job in </span><span id="location" style="color:#f6931f; font-weight:bold;"></span>
	<hr class="alt1" style="margin:0px 0;margin-bottom:20px;">
	<div style="background-color:#DDEDE6;">
	<table style="width:70%;"><tr><td width="40%">
	<span style="color:grey; font-weight:bold;">Target </span><span id="visits" style="color:#f6931f; font-weight:bold;"></span><span style="color:grey; font-weight:bold;"> visits @minimum cost</span></td><td width="60%">
<div id="slider-visits"></div>
</td></tr><tr><td width="40%">
	<span style="color:grey; font-weight:bold;">Target </span>
	<span style="color:#f6931f; font-weight:bold;">$</span><span id="cost" style="color:#f6931f; font-weight:bold;"></span><span style="color:grey; font-weight:bold;"> budget @maximum visits</span></td><td width="60%">
<div id="slider-cost"></div>
</td></tr></table>
	</div>


	<table cellspacing="0" cellpadding="0" class="sortable">
	<thead><tr class="alt first last">
		<th rel="0" value="Job Site">Job Site</th>
		<th rel="1" value="Monthly Users">Monthly Users</th>
		<th rel="2" value="Cost">Cost/Month <span id="cpmtotal" style="color:#f6931f; font-weight:bold;"></span></th>
		<th id="expsort" rel="3" value="Expected Visits">Expected Visits <span id="vpmtotal" style="color:#f6931f; font-weight:bold;"></span></th>
		<th rel="5" ><button class="small blue" style="width:90%;font-size:small;" type="submit" href="#myModal" data-toggle="modal" onclick="fillModal();">Publish</button></th>
		
	</tr></thead>
	
	<tbody>
	{% for site in jobsites %}
	<tr id="trsite{{site['sourceid']}}" class="">
		<td value="{{site['name']}}"><img src="{{site['logourl']}}" alt="{{site['name']}}" width="80px" height="30px"></img></td>
		<td value="{{site['users']}}">{{site['users']}} million</td>
		<td id="ourcpm{{site['sourceid']}}" value="{{site['ourcpm']}}" ourcpm="{{site['ourcpm']}}">
		{% if site['ourcpm'] > 0 %}
			${{site['ourcpm']}} 
			{% if (site['cpm'] - site['ourcpm']) > 0 %}
				<span style="color:darkgreen">(${{site['cpm'] - site['ourcpm']}} off)</span>
			{% endif %}
		{% else %}
			<span style="color:darkgreen">Free</span>
		{% endif %}
		
		</td>
		<td id="tdvpm{{site['sourceid']}}" value="{{site['vpm']}}"><div>
		<span id="vpm{{site['sourceid']}}" style="color:
		{% if site['vpm'] > 500 %}
		darkgreen
		{% elif site['vpm'] > 200 %}
		darkorange
		{% else %}
		red
		{% endif %}
		
		">
		{{site['vpm']}}
		</span>
		
		</div></td>
		<td value="">
		<div id="spin{{site['sourceid']}}"></div>
		<div id="check{{site['sourceid']}}" style="display:none;">
		{% if site['defaultpresent'] is sameas 1 %}
		<span id="publishicon{{site['sourceid']}}" class="icon small green" data-icon="c"></span>
		{% else %}
		<span id="publishicon{{site['sourceid']}}" class="icon small red" data-icon="x"></span>
		{% endif %}
		<input type="checkbox" checkboxsource="source" vpm="{{site['vpm']}}" autocomplete="off" sourceid="{{site['sourceid']}}" cpm="{{site['ourcpm']}}" onclick="updateTotals();" id="checkbox{{site['sourceid']}}" {% if site['ourcpm'] is sameas 0 %}checked="yes"{% endif %}/>
		</div>
		
		</td>
	</tr>
	{% endfor %}
	</tbody>
	</table>
</div>
</div>
<div id="tabr2" class="tab-content" style="background-color:white;">
</div>
<div id="tabr3" class="tab-content" style="background-color:white;">
</div>
</div
<!-- ===================================== END MAIN CONTENT  ===================================== -->

{% include "footer.html" %}

<script>
var noofsites = {{noofsites}};
var opts = {
  lines: 13, // The number of lines to draw
  length: 3, // The length of each line
  width: 2, // The line thickness
  radius: 4, // The radius of the inner circle
  corners: 1, // Corner roundness (0..1)
  rotate: 0, // The rotation offset
  color: '#000', // #rgb or #rrggbb
  speed: 1, // Rounds per second
  trail: 60, // Afterglow percentage
  shadow: false, // Whether to render a shadow
  hwaccel: false, // Whether to use hardware acceleration
  className: 'spinner', // The CSS class to assign to the spinner
  zIndex: 2e9, // The z-index (defaults to 2000000000)
  top: '0', // Top position relative to parent in px
  left: '0' // Left position relative to parent in px
};

{% for site in jobsites %}
	
{% endfor %}

var stopdelay = 0;
var demotype = '{{demotype}}';
var ctdelay = 1;
var delaytime = 500;
if(demotype == "all") {
	delaytime = 0;
}
var firstjoblink = "";

{% for job in demojobs %}
	if( (demotype == '{{job['demotype']}}') || (demotype == "all")) { 
		if(firstjoblink == "") {
			firstjoblink = "joblink{{job['jobid']}}";
		}
		$("#{{job['jobid']}}").delay(delaytime * ctdelay).fadeIn();
		stopdelay = ctdelay;
		ctdelay++;
	}
setTimeout("$('#tabl2').show()",delaytime * ctdelay);

{% endfor %}

//setTimeout('spinner.stop();', delaytime * stopdelay);
{% for site in jobsites %}
	/*setTimeout('var spinner{{site['sourceid']}} = new Spinner(opts).spin(document.getElementById("spin{{site['sourceid']}}"))',delaytime * ({{loop.index}} - 1));
	setTimeout('spinner{{site['sourceid']}}.stop()',delaytime * {{loop.index}});
	$("#spin{{site['sourceid']}}").delay(delaytime * {{loop.index}}).fadeOut();*/
	$("#check{{site['sourceid']}}").delay(delaytime * {{loop.index}}).fadeIn();
	
{% endfor %}
loadValues('{{demojobs[0]['jobid']}}','{{demojobs[0]['plan']}}','{{demojobs[0]['damping']}}','{{demojobs[0]['title']}}','{{demojobs[0]['city']}}, {{demojobs[0]['state']}}');


$( "#slider-visits" ).slider({
	range: "min",
	value: 9000,
	min: 100,
	max: 9000,
	slide: function( event, ui ) {
		$( "#visits" ).text(  ui.value );
	},
	stop: function( event, ui ) {
		var sliderval = parseInt(ui.value);
		var jobid = $( "#clickedjobinfo" ).attr('jobid');
		$( "#" + jobid ).attr('visits', sliderval);
		var i = 1;
		var totalvisits = 0;
		var pricylistcount = 0;
		var pricylist = [];
		for(i = 1; i <= noofsites;i++) {
				var val = parseInt($( '#vpm' + i ).text());
				var cost = parseInt($( '#ourcpm' + i ).attr('ourcpm'));
				if(cost == 0) {
					totalvisits = totalvisits + val;
				} else {
					pricylist.push(i);
					pricylistcount++;
				}
				
		}
		var pi = 0;
		while(sliderval > totalvisits) {
			if(pi > pricylistcount) {
				break;
			}
			var val = parseInt($( '#vpm' + pricylist[pi] ).text());
			totalvisits = totalvisits + val;
			$("#trsite" + pricylist[pi]).fadeIn();
			$("#checkbox" + pricylist[pi]).attr("checked","yes");
			pi++;
		}
		for(i = pi;i < pricylistcount;i++) {
			$("#trsite" + pricylist[i]).fadeOut();
			$("#checkbox" + pricylist[i]).removeAttr('checked');
			//alert('check' + pricylist[i]);
		}
		updateTotals('visits');
	}
});
$( "#visits" ).text( $( "#slider-visits" ).slider( "value" ) );

$( "#slider-cost" ).slider({
	range: "min",
	value: 0,
	min: 0,
	max: 1500,
	slide: function( event, ui ) {
		$( "#cost" ).text(  ui.value );
	},
	stop: function( event, ui ) {
		var sliderval = parseInt(ui.value);
		var jobid = $( "#clickedjobinfo" ).attr('jobid');
		$( "#" + jobid ).attr('visits', sliderval);
		var i = 1;
		var totalvisits = 0;
		var pricylistcount = 0;
		var pricylist = [];
		for(i = 1; i <= noofsites;i++) {
				var val = parseInt($( '#vpm' + i ).text());
				var cost = parseInt($( '#ourcpm' + i ).attr('ourcpm'));
				if(cost == 0) {
					totalvisits = totalvisits + val;
				} else {
					pricylist.push(i);
					pricylistcount++;
				}
				
		}
		var pi = 0;
		var totalcost = 0;
		while(totalcost <= sliderval) {
			if(pi > pricylistcount) {
				break;
			}
			var val = parseInt($( '#ourcpm' + pricylist[pi] ).attr('ourcpm'));
			totalcost = totalcost + val;
			if( totalcost >= sliderval) {
				break;
			}
			$("#trsite" + pricylist[pi]).fadeIn();
			$("#checkbox" + pricylist[pi]).attr("checked","yes");
			pi++;
		}
		for(i = pi;i < pricylistcount;i++) {
			$("#trsite" + pricylist[i]).fadeOut();
			$("#checkbox" + pricylist[i]).removeAttr('checked');
			//alert('check' + pricylist[i]);
		}
		updateTotals('cost');
	}
});
$( "#cost" ).text( $( "#slider-cost" ).slider( "value" ) );
//setTimeout('$("#trsite3").attr("style","display:none;");',4000);

function updateTotals(source)
{
	var cpmtotal = 0;
	var vpmtotal = 0;
	var ct = 0
	$('input').each(function(index) {
    	if(($(this).attr('type') == "checkbox")) {
    		if($(this).attr('checkboxsource') == "source") {
				if($(this).is(':checked')) {
					cpmtotal = cpmtotal + parseInt($(this).attr('cpm'));
					vpmtotal = vpmtotal + parseInt($(this).attr('vpm'));
					ct++;
				}
			}
    	}
	});
	$('#cpmtotal').text('$' + cpmtotal);
	$('#slider-cost').slider('value',cpmtotal);
	$( "#cost" ).text(cpmtotal);

	$('#vpmtotal').text(vpmtotal);
	if(source != "visits") {
		$('#slider-visits').slider('value',vpmtotal);
		$( "#visits" ).text(vpmtotal);
		
	}

}

function updatePublished()
{
	var cpmtotal = 0;
	var vpmtotal = 0;
	var ct = 0;
	$('input').each(function(index) {
    	if(($(this).attr('type') == "checkbox")) {
    		if($(this).attr('checkboxsource') == "source") {
				if($(this).is(':checked')) {
					var sourceid = $(this).attr('sourceid');
					if( $('#publishicon' + sourceid).attr('class') == "icon small red") {
						$('#publishicon' + sourceid).attr('class', 'icon small green');	
						$('#publishicon' + sourceid).attr('data-icon', 'c');
						$('#publishicon' + sourceid).children().text('c');			
					}
					ct++;
				}
    		}
    	}
	});
	
}

function fillModal()
{
	var cpmtotal = 0;
	var vpmtotal = 0;
	var ct = 0;
	$('input').each(function(index) {
    	if(($(this).attr('type') == "checkbox")) {
    		if($(this).attr('checkboxsource') == "source") {
				if($(this).is(':checked')) {
					cpmtotal = cpmtotal + parseInt($(this).attr('cpm'));
					vpmtotal = vpmtotal + parseInt($(this).attr('vpm'));
					var sourceid = $(this).attr('sourceid');
					$('#modal' + sourceid).show();
					ct++;
				}
			}
    	}
	});
	$('#publishvisits').text(vpmtotal);
	$('#publishcost').text(cpmtotal + '$');
}
$('#onetlink1').click();
$('#onetlink4').click();
$('#onetlink6').click();
updateTotals("init");
$('#' + firstjoblink).click();


function togglecheck(ele)
{
	if($(ele).is(':checked')) {
		$(ele).removeAttr('checked');
	} else {
		$(ele).attr('checked', 'yes');
	}
}


function loadBulkValues(onetdesc, onetcode, jobid)
{
		var ajaxRequest;  // The variable that makes Ajax possible!
		try{
			// Opera 8.0+, Firefox, Safari
			ajaxRequest = new XMLHttpRequest();
		} catch (e){
			// Internet Explorer Browsers
			try{
				ajaxRequest = new ActiveXObject("Msxml2.XMLHTTP");
			} catch (e) {
				try{
					ajaxRequest = new ActiveXObject("Microsoft.XMLHTTP");
				} catch (e){
					// Something went wrong
					alert("Your browser broke!");
					return false;
				}
			}
		}
		// Create a function that will receive data sent from the server
		ajaxRequest.onreadystatechange = function(){
			if(ajaxRequest.readyState == 4){
				
				var jsonresp = eval('(' + ajaxRequest.responseText + ')');
				
				var i = 1;
				for(i = 1; i < {{noofsites}};i++) {
					var color = 'red';
					if(jsonresp[i]['vpm'] > 500) {
						color = 'darkgreen';
					}
					else if(jsonresp[i]['vpm'] > 200) {
						color = 'darkorange';
					}
					
					var txt = jsonresp[i]['vpm'];
					//$('#tdvpm' + jsonresp[i]['sourceid']).attr('value', txt);
					$('#vpm' + jsonresp[i]['sourceid']).attr('style','color:' + color + ';');	
					$('#vpm' + jsonresp[i]['sourceid']).text(txt);
					$('#checkbox' + jsonresp[i]['sourceid']).attr('vpm',txt);
					if(jsonresp[i]['ourcpm'] > 0) {
						$('#checkbox' + jsonresp[i]['sourceid']).removeAttr('checked');
					}
					else {
						$('#checkbox' + jsonresp[i]['sourceid']).attr('checked','yes');
					}
					
				}
				$('#jobtitle').text(onetdesc);
				$('#location').text('');
				
				$("#expsort").click();
				setTimeout('$("#expsort").click();',0);
				//$("#expsort").click();
			}
		}
		var onetlist = new Array();
		$('li[litype*="onet"]').each(function(index) {
			if( $(this).hasClass('current') ) {
				onetlist.push($(this).attr('onetcode'));
				
			}
		});
		
	
		ajaxRequest.open("GET", '/getsitebulkvalues/' + onetlist.join('|') + '/' + jobid, false); 
		ajaxRequest.send(null); 

}



function loadValues(jobid, plan, damping, title, location)
{
		var ajaxRequest;  // The variable that makes Ajax possible!
		try{
			// Opera 8.0+, Firefox, Safari
			ajaxRequest = new XMLHttpRequest();
		} catch (e){
			// Internet Explorer Browsers
			try{
				ajaxRequest = new ActiveXObject("Msxml2.XMLHTTP");
			} catch (e) {
				try{
					ajaxRequest = new ActiveXObject("Microsoft.XMLHTTP");
				} catch (e){
					// Something went wrong
					alert("Your browser broke!");
					return false;
				}
			}
		}
		// Create a function that will receive data sent from the server
		ajaxRequest.onreadystatechange = function(){
			if(ajaxRequest.readyState == 4){
				
				var jsonresp = eval('(' + ajaxRequest.responseText + ')');
				
				var i = 1;
				for(i = 1; i < {{noofsites}};i++) {
					var color = 'red';
					if(jsonresp[i]['vpm'] > 500) {
						color = 'darkgreen';
					}
					else if(jsonresp[i]['vpm'] > 200) {
						color = 'darkorange';
					}
					
					var txt = jsonresp[i]['vpm'];
					//$('#tdvpm' + jsonresp[i]['sourceid']).attr('value', txt);
					$('#vpm' + jsonresp[i]['sourceid']).attr('style','color:' + color + ';');	
					$('#vpm' + jsonresp[i]['sourceid']).text(txt);
					$('#checkbox' + jsonresp[i]['sourceid']).attr('vpm',txt);
					if(jsonresp[i]['ourcpm'] > 0) {
						$('#checkbox' + jsonresp[i]['sourceid']).removeAttr('checked');
					}
					else {
						$('#checkbox' + jsonresp[i]['sourceid']).attr('checked','yes');
					}
					
				}
				$('#jobtitle').text(title);
				$('#location').text(location);
				
				$("#expsort").click();
				setTimeout('$("#expsort").click();',0);
				//$("#expsort").click();
			}
		}
		ajaxRequest.open("GET", '/getsitevalues/rating' + plan + '/' + damping, false); 
		ajaxRequest.send(null); 

}


</script>

</body></html>  
  
  
{% endblock %}
